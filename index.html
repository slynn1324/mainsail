<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <title>Mainsail</title>
        <meta name="description" content="Mainsail is the popular web interface for Klipper." />

        <link rel="icon" type="image/png" sizes="32x32" href="/img/icons/favicon-32x32.png" />
        <link rel="icon" type="image/png" sizes="16x16" href="/img/icons/favicon-16x16.png" />
        <meta name="theme-color" content="#121212" />
        <meta name="mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="apple-mobile-web-app-title" content="Mainsail" />
        <link rel="apple-touch-icon" sizes="180x180" href="/img/icons/apple-touch-icon-180x180.png" />
        <link rel="mask-icon" href="img/icons/safari-pinned-tab.svg" color="#d51f26" />
        <meta name="msapplication-TileImage" content="/img/icons/mstile-150x150.png" />
        <meta name="msapplication-TileColor" content="#d51f26" />

<script>
    window.autoplay = window.location.hash.indexOf("autoplay") >= 0;
</script>

        <script type="module" src="/src/main.ts"></script>
    </head>
    <body style="background-color: #121212">
        <noscript>
            <strong>
                We're sorry but Mainsail doesn't work properly without JavaScript enabled. Please enable it to continue.
            </strong>
        </noscript>
        <div id="app"></div>
        <script>
const restartPause = 2000;

class WebRTCVideoReceiver {
    constructor(videoElement) {
        this.videoElement = videoElement;
        this.terminated = false;
        this.ws = null;
        this.pc = null;
        this.restartTimeout = null;
        this.start();
    }

    start() {
        console.log("connecting");

        let url = this.videoElement.getAttribute("webRtcSrc");

        if ( !url ){
            console.error("no webRtcSrc url");
            return;
        }

        console.log("webRtcSrc=", url);

        //this.ws = new WebSocket(window.location.href.replace(/^http/, "ws") + 'ws');
        // this.ws = new WebSocket(window.streamUrl);
        this.ws = new WebSocket(url);

        this.ws.onerror = () => {
            console.log("ws error");
            if (this.ws === null) {
                return;
            }
            this.ws.close();
            this.ws = null;
        };

        this.ws.onclose = () => {
            console.log("ws closed");
            this.ws = null;
            this.scheduleRestart();
        };

        this.ws.onmessage = (msg) => this.onIceServers(msg);
    }

    terminate(){
        this.terminated = true;

        this.ws.close();
        this.pc.close();
    }

    onIceServers(msg) {
        if (this.ws === null) {
            return;
        }

        const iceServers = JSON.parse(msg.data);

        this.pc = new RTCPeerConnection({
            iceServers,
        });

        this.ws.onmessage = (msg) => this.onRemoteDescription(msg);
        this.pc.onicecandidate = (evt) => this.onIceCandidate(evt);

        this.pc.oniceconnectionstatechange = () => {
            if (this.pc === null) {
                return;
            }

            console.log("peer connection state:", this.pc.iceConnectionState);

            switch (this.pc.iceConnectionState) {
            case "disconnected":
                this.scheduleRestart();
            }
        };

        this.pc.ontrack = (evt) => {
            console.log("new track " + evt.track.kind);
            // document.getElementById("video").srcObject = evt.streams[0];
            this.videoElement.srcObject = evt.streams[0];
        };

        const direction = "sendrecv";
        this.pc.addTransceiver("video", { direction });
        this.pc.addTransceiver("audio", { direction });

        this.pc.createOffer()
            .then((desc) => {
                if (this.pc === null || this.ws === null) {
                    return;
                }

                this.pc.setLocalDescription(desc);

                console.log("sending offer");
                this.ws.send(JSON.stringify(desc));
            });
    }

    onRemoteDescription(msg) {
        if (this.pc === null || this.ws === null) {
            return;
        }

        this.pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.data)));
        this.ws.onmessage = (msg) => this.onRemoteCandidate(msg);
    }

    onIceCandidate(evt) {
        if (this.ws === null) {
            return;
        }

        if (evt.candidate !== null) {
            if (evt.candidate.candidate !== "") {
                this.ws.send(JSON.stringify(evt.candidate));
            }
        }
    }

    onRemoteCandidate(msg) {
        if (this.pc === null) {
            return;
        }

        this.pc.addIceCandidate(JSON.parse(msg.data));
    }

    scheduleRestart() {
        if (this.ws !== null) {
            this.ws.close();
            this.ws = null;
        }

        if (this.pc !== null) {
            this.pc.close();
            this.pc = null;
        }

        if (this.terminated) {
            return;
        }

        this.restartTimeout = window.setTimeout(() => {
            this.restartTimeout = null;
            this.start();
        }, 2000);
    }
}

window.startWebRTCVideo = (el) => {
    if ( el ){
        return new WebRTCVideoReceiver(el);
    }
    console.log("el is not defined");
}

// window.addEventListener('DOMContentLoaded', () => new WebRTCVideoReceiver());

        </script>
    </body>
</html>
